name: Upload Photos to S3

on:
  workflow_dispatch:
    inputs:
      bucket_path:
        description: 'S3 ë²„í‚· ë‚´ ê²½ë¡œ (ì˜ˆ: photos/2024)'
        required: false
        default: 'photos'

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Upload photos to S3
        id: upload
        run: |
          ASSET_DIR="asset_test"
          S3_BUCKET="${{ secrets.S3_BUCKET_NAME }}"
          S3_PATH="${{ inputs.bucket_path }}"
          UPLOADED_COUNT=0
          
          if [ ! -d "$ASSET_DIR" ]; then
            echo "âŒ asset í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # ì§€ì›í•˜ëŠ” ì´ë¯¸ì§€ í™•ìž¥ìž
          for file in "$ASSET_DIR"/*.{jpg,jpeg,png,gif,webp}; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "ðŸ“¤ $filename ì—…ë¡œë“œ ì¤‘..."
              
              # S3ì— ì—…ë¡œë“œ
              aws s3 cp "$file" "s3://$S3_BUCKET/$S3_PATH/$filename"
              
              if [ $? -eq 0 ]; then
                echo "âœ… $filename ì—…ë¡œë“œ ì™„ë£Œ"
                ((UPLOADED_COUNT++))
              else
                echo "âŒ $filename ì—…ë¡œë“œ ì‹¤íŒ¨"
                exit 1
              fi
            fi
          done
          
          echo "uploaded_count=$UPLOADED_COUNT" >> $GITHUB_OUTPUT
          
          if [ $UPLOADED_COUNT -eq 0 ]; then
            echo "âš ï¸  ì—…ë¡œë“œí•  ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi
      
      - name: Delete uploaded photos
        if: steps.upload.outputs.uploaded_count > 0
        run: |
          ASSET_DIR="asset"
          
          for file in "$ASSET_DIR"/*.{jpg,jpeg,png,gif,webp}; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              rm "$file"
              echo "ðŸ—‘ï¸  $filename ì‚­ì œ ì™„ë£Œ"
            fi
          done
      
      - name: Upload Summary
        if: always()
        run: |
          echo "## S3 ì—…ë¡œë“œ ì™„ë£Œ âœ¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì—…ë¡œë“œëœ ì‚¬ì§„**: ${{ steps.upload.outputs.uploaded_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 ë²„í‚·**: ${{ secrets.S3_BUCKET_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 ê²½ë¡œ**: ${{ inputs.bucket_path }}" >> $GITHUB_STEP_SUMMARY
