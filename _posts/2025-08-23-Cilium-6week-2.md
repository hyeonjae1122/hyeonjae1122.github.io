---
layout: post
title:  "[Cilium Study 1ê¸° by Gasida] - Advanced Gateway API Use Cases"
categories: [kubernetes,Networking]
tags: [cilium,Networking]
---

# Gatewayã€€APIì˜ ê³ ê¸‰ ì‚¬ìš© ì‚¬ë¡€ (Advanced Gateway API Use Cases) 

## ì‚¬ì „ ì¤€ë¹„ ì‚¬í•­

- Ciliumì€ `kubeProxyReplacement`ë¥¼ trueë¡œ ì„¤ì •


- CRDê°€ ì‚¬ìš© ê°€ëŠ¥í•œì§€ í™•ì¸
```bash
kubectl get crd \
  gatewayclasses.gateway.networking.k8s.io \
  gateways.gateway.networking.k8s.io \
  httproutes.gateway.networking.k8s.io \
  referencegrants.gateway.networking.k8s.io \
  tlsroutes.gateway.networking.k8s.io \
  grpcroutes.gateway.networking.k8s.io
```
![img_45.png](../assets/6week/img_45.png)

ì´ë²ˆ ì‹¤ìŠµ ë©ì—ì„œëŠ” ì´ë¯¸ ì•„ë˜ì™€ ê°™ì€ flagë¡œ Ciliumì´ ì„¤ì¹˜ ë˜ì–´ìˆë‹¤. 
```bash
--set kubeProxyReplacement=true \
--set gatewayAPI.enabled=true
```

Ciliumì´ ì œëŒ€ë¡œ ì„¤ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
```bash
cilium status --wait
```

![img_46.png](../assets/6week/img_46.png)

Ciliumì´ Gateway API ê¸°ëŠ¥ê³¼ í•¨ê»˜ í™œì„±í™”ë˜ê³  ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
```bash
cilium config view | grep -w "enable-gateway-api "
```
![img_47.png](../assets/6week/img_47.png)

## ë¡œë“œë°¸ëŸ°ì„œ
Cilium Service Mesh Gateway API ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” LoadBalancer íƒ€ì…ì˜ ì¿ ë²„ë„¤í‹°ìŠ¤ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ê¸°ëŠ¥ì´ í•„ìš”í•˜ë‹¤.
ê°€ìƒ ë¨¸ì‹ ì—ì„œ Kindë¥¼ ì‚¬ìš©í•œë‹¤ë©´, í´ë¼ìš°ë“œ ì œê³µìê°€ ì œê³µí•˜ëŠ” ë¡œë“œ ë°¸ëŸ°ì„œ í†µí•© ê¸°ëŠ¥ì„ í™œìš©í•  ìˆ˜ ì—†ë‹¤.
ë”°ë¼ì„œ ì´ ë©ì—ì„œëŠ” Cilium ìì²´ì˜ LoadBalancer ê¸°ëŠ¥ì„ ì‚¬ìš©í•œë‹¤.
ì´ ê¸°ëŠ¥ì€ LoadBalancer ì„œë¹„ìŠ¤ì— í• ë‹¹ëœ IP ì£¼ì†Œ ê´€ë¦¬(IPAM)ì™€ ë ˆì´ì–´ 2(Layer 2)ë¥¼ í†µí•œ IP ì£¼ì†Œ ì•Œë¦¼ì„ ì œê³µí•¨.


### ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
ë²ˆì—ëŠ” Gatewayê°€ í—¤ë”ì™€ ë‹¤ë¥¸ HTTP ë§¤ê°œë³€ìˆ˜ë¥¼ ì–´ë–»ê²Œ ìˆ˜ì •í•˜ëŠ”ì§€ ë³´ì—¬ì£¼ê¸° ìœ„í•´ ìƒ˜í”Œ echo ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•œë‹¤.
ì´ ì•±ì€ ì‘ë‹µ ë³¸ë¬¸ì— ì›ë˜ ìš”ì²­ í—¤ë”ì— ëŒ€í•œ ì •ë³´ë¥¼ í¬í•¨í•œë‹¤.

echo ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
```bash
kubectl apply -f echo-servers.yaml
```

```yaml
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: echo-1
  name: echo-1
spec:
  ports:
    - port: 8080
      name: high
      protocol: TCP
      targetPort: 8080
  selector:
    app: echo-1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: echo-1
  name: echo-1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: echo-1
  template:
    metadata:
      labels:
        app: echo-1
    spec:
      containers:
        - image: gcr.io/kubernetes-e2e-test-images/echoserver:2.2
          name: echo-1
          ports:
            - containerPort: 8080
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
```

íŒŒë“œ ë°°í¬í™•ì¸
```bash
kubectl get pods
```
ì„œë¹„ìŠ¤ ë°°í¬í™•ì¸
```bash
kubectl get svc
```
![img_49.png](../assets/6week/img_49.png)

ì´ ì„œë¹„ìŠ¤ëŠ” ClusterIP íƒ€ì…ì´ë¼ì„œ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆê³ , ì™¸ë¶€ì—ì„œëŠ” ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤.

### Gatewayì™€ HTTPRoute ë°°í¬

Gatewayì™€ HTTPRoute ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ë°°í¬
```bash
kubectl apply -f gateway.yaml -f http-route.yaml
```

Gateway APIë¥¼ ìœ„í•´ ìƒì„±ëœ **cilium-gateway-cilium-gw**ë¼ëŠ” ì´ë¦„ì˜ LoadBalancer ì„œë¹„ìŠ¤ë¥¼ í™•ì¸

![img_50.png](../assets/6week/img_50.png)

Gatewayì—ë„ ì£¼ì†Œí• ë‹¹ í™•ì¸
```bash
kubectl get gateway
```
![img_51.png](../assets/6week/img_51.png)

GATEWAYë¼ëŠ” ë³€ìˆ˜ì— IPí• ë‹¹í•˜ê¸°
```bash
GATEWAY=$(kubectl get gateway cilium-gw -o jsonpath='{.status.addresses[0].value}')
echo $GATEWAY
```
![img_52.png](../assets/6week/img_52.png)

íŠ¸ë˜í”½ í”„ë¡ì‹œ í™•ì¸. URLê²½ë¡œë¥¼ ê¸°ë°˜ìœ¼ë¡œ Gateway APIê°€ íŠ¸ë˜í”½ì„ í”„ë¡ì‹œí•˜ëŠ”ì§€ í™•ì¸í•œë‹¤. 
```bash
curl --fail -s http://$GATEWAY/echo
```
![img_54.png](../assets/6week/img_54.png)

ì‘ë‹µì—ì„œ ì›ë˜ ìš”ì²­ì— í¬í•¨ë˜ì—ˆë˜ í—¤ë”ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

## HTTP í—¤ë” ìš”ì²­ ìˆ˜ì • (HTTP Header Request Modifier)

### HTTP í—¤ë” ìˆ˜ì •ì´ë€?
HTTP í—¤ë” ìˆ˜ì •ì€ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì— ìˆëŠ” HTTP í—¤ë”ë¥¼ ì¶”ê°€, ì‚­ì œí•˜ê±°ë‚˜ ë³€ê²½í•˜ëŠ” ê³¼ì •ì´ë‹¤.
Cilium Gateway APIë¥¼ ì‚¬ìš©í•˜ë©´ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ì‚¬ìš©ìì˜ íŠ¹ì • ìš”êµ¬ì‚¬í•­ì— ë§ê²Œ ì‰½ê²Œ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆí•  ìˆ˜ ìˆë‹¤.

### HTTPRoute ë°°í¬

ì´ì „ ì‘ì—…ì—ì„œ ë°°í¬í•œ ê²ƒê³¼ ë™ì¼í•œ Gatewayë¥¼ ì‚¬ìš©í•´ì„œ ë‹¤ìŒ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ë°°í¬
```bash
kubectl apply -f echo-header-http-route.yaml
```

ì£¼ì„ì²˜ë¦¬ëœ ë¶€ë¶„ì€ ë‚˜ì¤‘ì•  í•´ì œ
```yaml
---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: header-http-echo
spec:
  parentRefs:
    - name: cilium-gw
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /cilium-add-a-request-header
      #filters:
      #- type: RequestHeaderModifier
      #  requestHeaderModifier:
      #    add:
      #    - name: my-cilium-header-name
      #      value: my-cilium-header-value
      backendRefs:
        - name: echo-1
          port: 8080
```

Gatewayì˜ IP ì£¼ì†Œë¥¼ ê°€ì ¸ì™€ì„œ í™•ì¸í•˜ì.
```bash
GATEWAY=$(kubectl get gateway cilium-gw -o jsonpath='{.status.addresses[0].value}')
echo $GATEWAY
```

ì™¸ë¶€ ì£¼ì†Œë¡œ HTTP ìš”ì²­ì„ ë³´ë‚¸ë‹¤.
```bash
curl --fail -s http://$GATEWAY/cilium-add-a-request-header
```

ì‘ë‹µì—ì„œ ì›ë˜ ìš”ì²­ í—¤ë”ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.
![img_55.png](../assets/6week/img_55.png)

ì´ì œ ì—ë””í„°ë¡œ ëŒì•„ê°€ì„œ echo-header-http-route.yaml íŒŒì¼ì˜ ì£¼ì„ì²˜ë¦¬ëœ ì¤„ì„ í•´ì œí•œë‹¤. 

![img_56.png](../assets/6week/img_56.png)

HTTPRouteë¥¼ ì¬ì ìš©í•œë‹¤.

```bash
kubectl apply -f echo-header-http-route.yaml
```

ì´ì œ Cilium Gateway APIê°€ í—¤ë”ë¥´ ìˆ˜ì •í–ˆëŠ”ì§€ í™•ì¸í•´ë³¸ë‹¤. ë™ì¼í•œ ì£¼ì†Œë¡œ curl ìš”ì²­ì„ ë‹¤ì‹œë³´ë‚¸ë‹¤.

```bash
curl --fail -s http://$GATEWAY/cilium-add-a-request-header
```

![img_57.png](../assets/6week/img_57.png)

ì‘ë‹µì˜ Request Headers ì„¹ì…˜ì— my-cilium-header-name=my-cilium-header-value í—¤ë”ê°€ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


### ê´€ì¸¡ê°€ëŠ¥ì„±

Hubbleë¡œ íŠ¸ë˜í”½ì„ ê´€ì°°í•´ë³¸ë‹¤. ë¨¼ì € hubble ì»¤ë§¨ë“œë¥¼ ì´ìš©í•´ì„œ íŠ¸ë˜í”½ì„ í•„í„°ë§í•´ë³´ì.  
```bash
hubble observe --http-path "/cilium-add-a-request-header"
```

![img_58.png](../assets/6week/img_58.png)

ì´ ì¶œë ¥ì„ í†µí•´ íŠ¸ë˜í”½ì´ Cilium L7 Ingress(Gateway APIë¥¼ êµ¬í˜„)ì„ í†µí•´ ì „ì†¡ë˜ì—ˆê³  HTTP ê²½ë¡œì™€ ê°™ì€ ë ˆì´ì–´ 7 í•„í„°ë¥¼ ì‚¬ìš©í•´ì„œ íŠ¸ë˜í”½ì„ ê´€ì°°í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

## HTTP ì‘ë‹µ í—¤ë” ì¬ì‘ì„± ê¸°ëŠ¥
ìš”ì²­ í—¤ë”ë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì´ ìœ ìš©í•˜ë“¯, ì‘ë‹µ í—¤ë”ë„ ë§ˆì°¬ê°€ì§€ë¡œ ì¬ì‘ì„±ì´ ê°€ëŠ¥í•˜ë‹¤.
ì˜ˆë¥¼ ë“¤ì–´, íŠ¹ì • ë°±ì—”ë“œë¡œ ë¦¬ë””ë ‰ì…˜ëœ ì‚¬ìš©ìë¥¼ ì‹ë³„í•˜ê¸° ìœ„í•´ íŠ¹ì • ë°±ì—”ë“œì— ëŒ€í•´ì„œë§Œ ì¿ í‚¤ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆë‹¤.

ë˜ ë‹¤ë¥¸ ì‚¬ìš© ì‚¬ë¡€ë¡œëŠ”, í”„ë¡ íŠ¸ì—”ë“œê°€ ë°±ì—”ë“œ ì„œë²„ê°€ ì•ˆì •(stable) ë²„ì „ì¸ì§€ ë² íƒ€(beta) ë²„ì „ì¸ì§€ ì•Œì•„ì•¼ í•  ë•Œê°€ ìˆë‹¤.
ì´ë¥¼ í†µí•´ í”„ë¡ íŠ¸ì—”ë“œëŠ” ë‹¤ë¥¸ UIë¥¼ ë Œë”ë§í•˜ê±°ë‚˜ ì‘ë‹µì„ ì ì ˆíˆ íŒŒì‹±í•  ìˆ˜ ìˆê²Œ ëœë‹¤.


### ì‘ë‹µ í—¤ë” ìˆ˜ì •

HTTPRouteë¥¼ ë°°í¬í•œë‹¤.
```bash
kubectl apply -f response-header-modifier-http-route.yaml
yq response-header-modifier-http-route.yaml
```

![img_59.png](../assets/6week/img_59.png)

ì´ë²ˆì—ëŠ” type: ResponseHeaderModifier í•„í„°ë¥¼ ì‚¬ìš©í•´ì„œ ì‘ë‹µ í—¤ë”ë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì— ì£¼ëª©í•˜ì. í•œ ë²ˆì— 3ê°œì˜ í—¤ë”ë¥¼ ì¶”ê°€í•œë‹¤.


Gateway IP ì£¼ì†Œ í™•ì¸ ë° ìš”ì²­ ë³´ë‚´ê¸°
```bash
GATEWAY=$(kubectl get gateway cilium-gw -o jsonpath='{.status.addresses[0].value}')
echo $GATEWAY
```

íŒ¨í‚· ë³¸ë¬¸ì— ì›ë˜ ìš”ì²­ì— ëŒ€í•œ ì„¸ë¶€ ì •ë³´ê°€ í¬í•¨
```angular2html
curl --fail -s http://$GATEWAY/multiple
```
![img_60.png](../assets/6week/img_60.png)


ì‘ë‹µ ë³¸ë¬¸ì˜ ìš”ì²­ í—¤ë” ì„¹ì…˜ë§Œ ë³´ê¸°
```bash
curl --fail -s http://$GATEWAY/multiple | grep "Request Headers" -A 10
```
![img_61.png](../assets/6week/img_61.png)


ì‘ë‹µì˜ í—¤ë”ë¥¼ ë³´ë ¤ë©´ curlì„ ìƒì„¸ ëª¨ë“œ(-v)ë¡œ ì‹¤í–‰í•´ì•¼í•œë‹¤.
```angular2html
curl -v --fail -s http://$GATEWAY/multiple
```

![img_62.png](../assets/6week/img_62.png)

ì•„ë˜ì™€ ê°™ì´ `<`ë¡œ ì‹œì‘í•˜ëŠ” í•„ë“œì—ì„œ ì‘ë‹µí—¤ë”ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤. Gateway APIê°€ ì‘ë‹µì— ì¶”ê°€í•œ í—¤ë”ë“¤ì„ í™•ì¸

![img_63.png](../assets/6week/img_63.png)

Cilium Gateway APIë¥¼ ì‚¬ìš©í•˜ë©´ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì´ë‚˜ ë‚˜ê°€ëŠ” ì‘ë‹µì˜ HTTP íŠ¸ë˜í”½ì„ ìˆ˜ì •í•˜ëŠ” ê²ƒì€ êµ‰ì¥íˆ ê°„ë‹¨í•œ ê²ƒì„ ì•Œ ìˆ˜ìˆë‹¤.

## HTTP íŠ¸ë˜í”½ ë¯¸ëŸ¬ë§

íŠ¸ë˜í”½ ë¯¸ëŸ¬ë§ì€ íŠ¹ì • ë°±ì—”ë“œë¡œ í–¥í•˜ëŠ” íŠ¸ë˜í”½ì„ ë‹¤ë¥¸ ë°±ì—”ë“œë¡œ ë³µì‚¬í•´ì„œ ë³´ë‚´ëŠ” ê¸°ëŠ¥ì´ë‹¤.
ì´ ê¸°ëŠ¥ì€ ë‹¤ìŒê³¼ ê°™ì€ ìƒí™©ì—ì„œ íŠ¹íˆ ìœ ìš©í•˜ë‹¤.
- ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ ë²„ì „ ë„ì… : v2ì™€ ê°™ì€ ìƒˆë¡œìš´ ë²„ì „ì˜ ì„œë¹„ìŠ¤ë¥¼ ë„ì…í•  ë•Œ, ì‹¤ì œ ì‚¬ìš©ì íŠ¸ë˜í”½ì„ ê·¸ëŒ€ë¡œ ë³µì œí•´ì„œ v2 ë°±ì—”ë“œë¡œ ë³´ë‚´ëŠ” ë°©ì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë‹¤. ì´ë¥¼ í†µí•´ ì‹¤ì œ íŠ¸ë˜í”½ í™˜ê²½ì—ì„œ v2ì˜ ì„±ëŠ¥ì´ë‚˜ ì•ˆì •ì„±ì„ ë¯¸ë¦¬ ê²€ì¦í•  ìˆ˜ ìˆë‹¤.
- ë¬¸ì œ í•´ê²° ë° ë¶„ì„ : ì‹¤ì‹œê°„ íŠ¸ë˜í”½ì„ ë³µì œí•´ì„œ ë¶„ì„ ë„êµ¬ë¡œ ë³´ë‚´ë©´, í”„ë¡œë•ì…˜ í™˜ê²½ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šê³  ë¬¸ì œë¥¼ ì§„ë‹¨í•˜ê±°ë‚˜ ì‚¬ìš©ì í–‰ë™ì„ ë¶„ì„ì´ ê°€ëŠ¥í•˜ë‹¤.

### ë¯¸ëŸ¬ë§
Gatewayë¥¼ ì‚¬ìš©í•´ì„œ í•œ ë°±ì—”ë“œë¡œ í–¥í•˜ëŠ” íŠ¸ë˜í”½ì„ ë‹¤ë¥¸ ë°±ì—”ë“œë¡œ ë¯¸ëŸ¬ë§ì„ í•œë‹¤.
ìƒˆë¡œìš´ ë°ëª¨ì•±ì„ ë°°í¬ í•œë‹¤. (íŒŒë“œì™€ ì„œë¹„ìŠ¤)
- infra-backend-v1
- infra-backend-v2 (infra-backend-v1ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ infra-backend-v2ë¡œ ë¯¸ëŸ¬ë§)

ë°°í¬ í™•ì¸
```bash
kubectl get -f demo-app.yaml
```
ë‹¤ë¥¸ ë°±ì—”ë“œë¡œ íŠ¸ë˜í”½ì„ ë¯¸ëŸ¬ë§í•˜ëŠ” ê²ƒì€ ë¬¸ì œ í•´ê²°, ë¶„ì„, ê·¸ë¦¬ê³  ê´€ì°° ê°€ëŠ¥ì„±ì„ ë†’ì´ëŠ” ë° ìœ ìš©í•˜ë‹¤. íŠ¸ë˜í”½ì„ ë¯¸ëŸ¬ë§í•˜ë”ë¼ë„
ê·¸ ë°±ì—”ë“œë¡œë¶€í„°ì˜ ì‘ë‹µì€ ë¬´ì‹œí•œë‹¤.


HTTPRouteë¥¼ ë°°í¬
```bash
kubectl apply -f http-mirror-route.yaml
yq .spec http-mirror-route.yaml
```

![img_64.png](../assets/6week/img_64.png)


```bash
GATEWAY=$(kubectl get gateway cilium-gw -o jsonpath='{.status.addresses[0].value}')
echo $GATEWAY
```
![img_66.png](../assets/6week/img_66.png)

```bash
curl -s http://$GATEWAY/mirror | jq
```

![img_65.png](../assets/6week/img_65.png)


ë°±ì—”ë“œ ë¡œê·¸íƒ­ í™•ì¸
infra-backend-v1, infra-backend-v2 íŒŒë“œëŠ” ì ‘ê·¼ ë¡œê·¸ë¥¼ ëª¨ë‹ˆí„°ë§ ì¤‘
í˜„ì¬ëŠ” ì™¼ìª½ íŒ¨ë„ì—ì„œë§Œ ë¡œê·¸ê°€ ë³´ì„
![img_67.png](../assets/6week/img_67.png)


### HTTPRoute ìˆ˜ì • ë° ì¬ì ìš©

ì—ë””í„°ì—ì„œ http-mirror-route.yaml íŒŒì¼ì˜ filters ì„¹ì…˜(14-19í–‰)ì˜ ì£¼ì„ì„ í•´ì œí›„ ì¬ì ìš©
```yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: request-mirror
spec:
  parentRefs:
  - name: cilium-gw
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /mirror
    filters:
    - type: RequestMirror      
      requestMirror:
        backendRef:
          name: infra-backend-v2
          port: 8080
    backendRefs:
    - name: infra-backend-v1
      port: 8080
```

ì¬ì ìš©
```bash
kubectl apply -f http-mirror-route.yaml
```

ë¯¸ëŸ¬ë§ì„ ìœ„í•´ íŠ¸ë˜í”½ì„ ìš”ì²­í•´ë³¸ë‹¤. 

```bash
curl -s http://$GATEWAY/mirror | jq
```

í™”ë©´ì´ ë¶„í• ëœ ì–‘ìª½ íŒ¨ë„ ëª¨ë‘ì— ë¡œê·¸ê°€ ë³´ì¸ë‹¤. ì´ëŠ” íŠ¸ë˜í”½ì´ infra-backend-v1ë¿ë§Œ ì•„ë‹ˆë¼ infra-backend-v2ì—ë„ ë³µì œë˜ì–´ ì „ì†¡ë˜ì—ˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤.

![img_68.png](../assets/6week/img_68.png)

## HTTP URL ì¬ì‘ì„±

URL ì¬ì‘ì„±ì€ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì´ í”„ë¡ì‹œë˜ê¸° ì „ì— ì‚¬ìš©ëœ URLì„ ìˆ˜ì •í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.
- ê²½ë¡œ(Path) ìˆ˜ì •: í´ë¼ì´ì–¸íŠ¸ê°€ `/v1/api/users`ë¡œ ìš”ì²­ì„ ë³´ëƒˆì„ ë•Œ, ë°±ì—”ë“œ ì„œë¹„ìŠ¤ì—ì„œëŠ” `/users`ì™€ ê°™ì´ API ë²„ì „ì„ ì œê±°í•œ ê²½ë¡œë¡œ ë³´ë‚´ì•¼ í•  ë•Œ
- í˜¸ìŠ¤íŠ¸ëª…(Hostname) ë³€ê²½: ì—¬ëŸ¬ ë„ë©”ì¸(ì˜ˆ: blog.example.com, shop.example.com)ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ë‹¨ì¼ ë°±ì—”ë“œ ì„œë¹„ìŠ¤(ì˜ˆ: main-service)ë¡œ ë¼ìš°íŒ…í•˜ë©´ì„œ, ë°±ì—”ë“œê°€ ì˜¬ë°”ë¥¸ í˜¸ìŠ¤íŠ¸ëª…ì„ ì¸ì‹í•˜ë„ë¡ ìˆ˜ì •í•´ì•¼ í•  ë•Œ


### HTTPRoute ì‘ì„±

```
yq http-rewrite-route.yaml
```

![img_69.png](../assets/6week/img_69.png)

```bash
kubectl apply -f http-rewrite-route.yaml
```

ì•„ë˜ì™€ ê°™ì´ ê·œì¹™ì„ ì‚´í´ë³¸ë‹¤. 
- ìš”ì²­ URLì˜ /prefix/oneì„ /oneìœ¼ë¡œ êµì²´í•˜ëŠ” ì—­í• 
![img_70.png](../assets/6week/img_70.png)


Gateway APIê°€ URL ê²½ë¡œë¥¼ í”„ë¡ì‹œí•˜ê³  ìˆ˜ì •í•˜ëŠ”ì§€ í™•ì¸í•´ ë³´ì. ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì™¸ë¶€ ì£¼ì†Œì™€ ê²½ë¡œë¡œ HTTP ìš”ì²­ì„ ë³´ë‚¸ë‹¤.
```
curl -s http://$GATEWAY/prefix/one | jq
```

ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë³´ë©´, ì—ì½” ì„œë²„ê°€ ì›ë˜ ìš”ì²­ì„ ë³µì‚¬í•´ì„œ íŒ¨í‚· ë³¸ë¬¸ì— ì‘ë‹µì„ ë³´ë‚´ì¤€ ê²ƒì„ ì•Œ ìˆ˜ ìˆì–´.

![img_71.png](../assets/6week/img_71.png)


ì´ ì¶œë ¥ì€ Gatewayê°€ ì›ë˜ ìš”ì²­ì˜ ê²½ë¡œë¥¼ `/prefix/one`ì—ì„œ `/one`ìœ¼ë¡œ ë³€ê²½í–ˆë‹¤ëŠ” ê²ƒì„ ë³´ì—¬ì¤€ë‹¤.
ì¶œë ¥ ê²°ê³¼ì˜ "path" í•„ë“œë¥¼ ë³´ë©´ í™•ì¸í•  ìˆ˜ ìˆë‹¤. L7 íŠ¸ë˜í”½ ì²˜ë¦¬ì— Envoyë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—, EnvoyëŠ” íŒ¨í‚·ì— ì›ë˜ ê²½ë¡œ(`"X-Envoy-Original-Path"`)ì— ëŒ€í•œ ì •ë³´ë„ ì¶”ê°€í•œë‹¤.
ë˜í•œ, HTTP ìš”ì²­ì˜ URL ì¬ì‘ì„±ì€ ì´ì „ ë©ì—ì„œ ë‹¤ë¤˜ë˜ ê¸°ëŠ¥ë“¤ê³¼ ê²°í•©í•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, URL ê²½ë¡œë¥¼ ì¬ì‘ì„±í•˜ë©´ì„œ ë™ì‹œì— ì»¤ìŠ¤í…€ HTTP í—¤ë”ë¥¼ ì¶”ê°€í•  ìˆ˜ë„ ìˆë‹¤


## HTTP Traffice Redirect
ë¦¬ë””ë ‰ì…˜ì€ ì‚¬ìš©ìë¥¼ ë‹¤ë¥¸ URLë¡œ ë³´ë‚´ëŠ” ê¸°ëŠ¥ì´ë‹¤. Gateway APIë¥¼ ì‚¬ìš©í•˜ë©´ ë¦¬ë””ë ‰ì…˜ ë©”ì‹œì§€ì—ì„œ ê²½ë¡œ, í˜¸ìŠ¤íŠ¸ëª…, ê·¸ë¦¬ê³  301(ì˜êµ¬ ì´ë™)ì´ë‚˜ 302(ì„ì‹œ ì´ë™) ê°™ì€ HTTP ë¦¬ë””ë ‰ì…˜ ì½”ë“œë¥¼ ì§ì ‘ ì§€ì •í•  ìˆ˜ ìˆë‹¤.
ì´ ê¸°ëŠ¥ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¼ì‹œì ìœ¼ë¡œ ë˜ëŠ” ì˜êµ¬ì ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•  ë•Œ íŠ¹íˆ ìœ ìš©í•˜ë‹¤.

### HTTP Path Redirect
ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” HTTP íŠ¸ë˜í”½ì„ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•  ê²ƒì´ë‹¤. 
HTTPRouteë¥¼ ë°°í¬í•˜ê³  Gateway IPì£¼ì†Œ íšë“.

```bash
kubectl apply -f redirect-route.yaml
GATEWAY=$(kubectl get gateway cilium-gw -o jsonpath='{.status.addresses[0].value}')
echo $GATEWAY
```

![img_72.png](../assets/6week/img_72.png)

redirect-route.yaml íŒŒì¼ì˜ ì²« ë²ˆì§¸ ê·œì¹™ì„ ì‚´í´ë³´ì.
```bash
yq '.spec.rules[0]' redirect-route.yaml
```
![img_73.png](../assets/6week/img_73.png)
ì´ ì„¤ì •ì€ /original-prefixë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ /replacement-prefixë¡œ ë¦¬ë””ë ‰ì…˜í•˜ëŠ” ê·œì¹™ì´ë‹¤.

```bash
curl -l -v http://$GATEWAY/original-prefix
```

curl ëª…ë ¹ì–´ì— -l ì˜µì…˜ì„ ì‚¬ìš©í•œ ê²ƒì— ì£¼ëª©í•˜ì. ì´ ì˜µì…˜ì€ ë¦¬ë””ë ‰ì…˜ì„ ìë™ìœ¼ë¡œ ë”°ë¼ê°€ë„ë¡ í•´ì¤€ë‹¤(ê¸°ë³¸ì ìœ¼ë¡œ curlì€ ë¦¬ë””ë ‰ì…˜ì„ ë”°ë¼ê°€ì§€ ì•ŠìŒ).
ë˜í•œ, ì‘ë‹µ í—¤ë”ë¥¼ ë³´ê¸° ìœ„í•´ -v(verbose) ì˜µì…˜ë„ ì‚¬ìš©í•œë‹¤.

![img_74.png](../assets/6week/img_74.png)
ë¦¬ë‹¤ì´ë ‰ì…˜ ë©”ì‹œì§€ì˜ location í—¤ë”ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ìƒˆë¡œìš´ ëª©ì ì§€ë¥¼ ì•Œë ¤ì£¼ëŠ” ì—­í• ì„ í•œë‹¤.
ë³´ë‹¤ì‹œí”¼, í´ë¼ì´ì–¸íŠ¸ëŠ” http://172.18.255.200:80/replacement-prefixë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜ ë˜ì—ˆë‹¤.

### ìƒˆë¡œìš´ í˜¸ìŠ¤íŠ¸ë„¤ì„ ë° í”„ë¦¬í”½ìŠ¤ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

```
yq '.spec.rules[1]' redirect-route.yaml
```

![img_75.png](../assets/6week/img_75.png)
`/path-and-host` ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì„ `example.org` í˜¸ìŠ¤íŠ¸ì˜ `/replacement-prefix` ê²½ë¡œë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜í•œë‹¤


```
curl -l -v http://$GATEWAY/path-and-host
```

![img_76.png](../assets/6week/img_76.png)
í´ë¼ì´ì–¸íŠ¸ëŠ” http://example.org:80/replacement-prefixë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜ë˜ì—ˆë‹¤.ì´ ì˜ˆì œì—ì„œëŠ” í˜¸ìŠ¤íŠ¸ëª…ê³¼ ê²½ë¡œ ì ‘ë‘ì‚¬ê°€ ëª¨ë‘ ìˆ˜ì •ë˜ì—ˆë‹¤.


### ë¦¬ë‹¤ì´ë ‰íŠ¸ - ìƒˆë¡œìš´ ìƒíƒœì½”ë“œì™€ ìƒˆë¡œìš´ í”„ë¦¬í”½ìŠ¤
ê¸°ë³¸ì ìœ¼ë¡œ, ë¦¬ë‹¤ì´ë ‰ì…˜ ìƒíƒœ ì½”ë“œëŠ” 302(ì„ì‹œ ì´ë™)ì´ë‹¤. ì´ëŠ” ë¦¬ì†ŒìŠ¤ê°€ ì„ì‹œë¡œ ì´ë™í–ˆìŒì„ ì˜ë¯¸í•œë‹¤.

í•˜ì§€ë§Œ í´ë¼ì´ì–¸íŠ¸ê°€ ì ‘ê·¼í•˜ë ¤ëŠ” ë¦¬ì†ŒìŠ¤ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì´ë™í–ˆìŒì„ ì•Œë¦¬ë ¤ë©´ 301 ìƒíƒœ ì½”ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. 
ì´ ê¸°ëŠ¥ì€ ê²½ë¡œ ì ‘ë‘ì‚¬ êµì²´ì™€ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ë„ ìˆë‹¤.

```bash
yq '.spec.rules[2]' redirect-route.yaml
```

![img_77.png](../assets/6week/img_77.png)

`/path-and-status` ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì— ëŒ€í•´ 301 ìƒíƒœ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ê³ , `/replacement-prefix`ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜í•˜ëŠ” ê·œì¹™


```
curl -l -v http://$GATEWAY/path-and-status
```
![img_78.png](../assets/6week/img_78.png)



![img_79.png](../assets/6week/img_79.png)
ë°˜í™˜ëœ ìƒíƒœ ì½”ë“œê°€ **301 Moved Permanently**ì´ê³ , í´ë¼ì´ì–¸íŠ¸ëŠ” http://172.18.255.200:80/replacement-prefixë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜ ë˜ì–´ìˆë‹¤.

### ë¦¬ë‹¤ì´ë ‰íŠ¸ - HTTPì—ì„œ HTTPSë¡œ, ê·¸ë¦¬ê³  ìƒˆë¡œìš´ í”„ë¦¬í”½ìŠ¤

```
yq '.spec.rules[3]' redirect-route.yaml
```
![img_80.png](../assets/6week/img_80.png)
`/scheme-and-host` ê²½ë¡œë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì— ëŒ€í•´ `example.org` í˜¸ìŠ¤íŠ¸ë¡œ ë¦¬ë””ë ‰ì…˜í•˜ë©´ì„œ, í”„ë¡œí† ì½œ ìŠ¤í‚¤ë§ˆë¥¼ `https`ë¡œ ë³€ê²½í•˜ëŠ” ê·œì¹™ì´ë‹¤.


```bash
curl -l -v http://$GATEWAY/scheme-and-host
```
![img_81.png](../assets/6week/img_81.png)

í´ë¼ì´ì–¸íŠ¸ëŠ” ì²˜ìŒì—ëŠ” HTTPë¡œ ì—°ê²°ì„ ì‹œë„í–ˆì§€ë§Œ, **https://example.org:443/scheme-and-host**ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜ ë˜ì–´ìˆë‹¤. 
Gateway APIë¥¼ í†µí•´ ìŠ¤í‚¤ë§ˆë¥¼ ì†ì‰½ê²Œ ë³€ê²½ê°€ëŠ¥í•˜ë‹¤



## ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°„ ë¼ìš°íŒ…ì˜ ì¥ì 

Gateway APIëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°„ ë¼ìš°íŒ…ì„ í•µì‹¬ì ìœ¼ë¡œ ì§€ì›í•´. ì´ëŠ” ì—¬ëŸ¬ ì‚¬ìš©ìë‚˜ íŒ€ì´ í•˜ë‚˜ì˜ ë„¤íŠ¸ì›Œí¬ ì¸í”„ë¼ë¥¼ ê³µìœ í•˜ë©´ì„œë„, ì ‘ê·¼ ë° ì¥ì•  ë²”ìœ„ë¥¼ ìµœì†Œí™”í•˜ê¸° ìœ„í•´ ì œì–´ì™€ ì„¤ì •ì´ ë¶„ë¦¬ë˜ì–´ì•¼ í•  ë•Œ ë§¤ìš° ìœ ìš©í•´.

Gatewayì™€ RouteëŠ” ì„œë¡œ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë°°í¬ë  ìˆ˜ ìˆê³ , RouteëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²½ê³„ë¥¼ ë„˜ì–´ Gatewayì— ì—°ê²°ë  ìˆ˜ ìˆì–´.

ì´ëŸ¬í•œ ë¶„ë¦¬ ë•ë¶„ì— Routeì™€ Gatewayì— ëŒ€í•œ ì‚¬ìš©ì ì ‘ê·¼ ì œì–´ë¥¼ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë³„ë¡œ ë‹¤ë¥´ê²Œ ì ìš©í•  ìˆ˜ ìˆì–´. ê²°ê³¼ì ìœ¼ë¡œ, í´ëŸ¬ìŠ¤í„° ì „ë°˜ì˜ ë¼ìš°íŒ… ì„¤ì • ì¤‘ ê°ê¸° ë‹¤ë¥¸ ë¶€ë¶„ì— ëŒ€í•œ ì ‘ê·¼ê³¼ ì œì–´ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ë¶„ë¦¬í•  ìˆ˜ ìˆì§€.

Routeê°€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²½ê³„ë¥¼ ë„˜ì–´ Gatewayì— ì—°ê²°ë˜ëŠ” ê¸°ëŠ¥ì€ Route Attachment(ë¼ìš°íŠ¸ ì—°ê²°)ë¼ëŠ” ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ ì œì–´ë¼. ì´ ë©ì—ì„œëŠ” Route Attachmentë¥¼ ì‚´í´ë³´ê³ , ë…ë¦½ì ì¸ íŒ€ë“¤ì´ ì–´ë–»ê²Œ ë™ì¼í•œ Gatewayë¥¼ ì•ˆì „í•˜ê²Œ ê³µìœ í•  ìˆ˜ ìˆëŠ”ì§€ ë³´ì—¬ì¤„ ê±°ì•¼.


## ë¼ìš°íŠ¸ ì—°ê²°
Routeê°€ Gatewayì— ì—°ê²°ë˜ê³  ë¼ìš°íŒ… ê·œì¹™ì„ ì„¤ì •í•˜ëŠ” ë°©ì‹ì„ ê²°ì •í•˜ëŠ” ì¤‘ìš”í•œ ê°œë…ì´ì•¼. íŠ¹íˆ ì—¬ëŸ¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ê±¸ì³ Routeë“¤ì´ í•˜ë‚˜ ì´ìƒì˜ Gatewayë¥¼ ê³µìœ í•  ë•Œ ë”ìš± ì¤‘ìš”í•´.

ë¼ìš°íŠ¸ ì—°ê²°ì˜ íŠ¹ì§•
ì–‘ë°©í–¥ì„±: Gatewayì™€ Routeì˜ ì—°ê²°ì€ ì–‘ë°©í–¥ì ì´ì•¼. Gateway ì†Œìœ ìì™€ Route ì†Œìœ ì ëª¨ë‘ ê´€ê³„ì— ë™ì˜í•´ì•¼ë§Œ ì—°ê²°ì´ ì„±ê³µì ìœ¼ë¡œ ì´ë£¨ì–´ì ¸.

Gatewayì˜ ì—°ê²° ì œì•½(Attachment Constraints): GatewayëŠ” ë¦¬ìŠ¤ë„ˆ(listener)ì— ì—°ê²° ì œì•½ ì¡°ê±´ì„ ì„¤ì •í•  ìˆ˜ ìˆì–´. ì´ ì¡°ê±´ì€ ì–´ë–¤ Routeê°€ Gatewayì— ì—°ê²°ë  ìˆ˜ ìˆëŠ”ì§€ ì œí•œí•˜ëŠ” ì—­í• ì„ í•´. GatewayëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ Route íƒ€ì…ì„ ì—°ê²° ì œì•½ ì¡°ê±´ìœ¼ë¡œ ì§€ì›í•´. ì´ ì œì•½ì„ ì¶©ì¡±í•˜ì§€ ëª»í•˜ëŠ” RouteëŠ” Gatewayì— ì—°ê²°ë  ìˆ˜ ì—†ì–´.

Routeì˜ ë¶€ëª¨ ì°¸ì¡°(parentRef): ë§ˆì°¬ê°€ì§€ë¡œ, RouteëŠ” parentRef í•„ë“œë¥¼ í†µí•´ ìì‹ ì´ ì—°ê²°í•˜ë ¤ëŠ” Gatewayë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì°¸ì¡°í•´.

ì´ ë‘ ê°€ì§€ ë©”ì»¤ë‹ˆì¦˜ì´ í•©ì³ì ¸ì„œ ì¸í”„ë¼ ì†Œìœ ìì™€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì†Œìœ ì ê°„ì˜ í•¸ë“œì…°ì´í¬ë¥¼ ë§Œë“¤ì–´ ë‚´. ì´ë¥¼ í†µí•´ ì–‘ì¸¡ì´ ë…ë¦½ì ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ Gatewayë¥¼ í†µí•´ ì–´ë–»ê²Œ ë…¸ì¶œë ì§€ ì •ì˜í•  ìˆ˜ ìˆì§€.

ì´ê²ƒì€ ê´€ë¦¬ ë¶€ë‹´ì„ ì¤„ì—¬ì£¼ëŠ” íš¨ê³¼ì ì¸ ì •ì±…ì´ì•¼. ì• í”Œë¦¬ì¼€ì´ì…˜ ì†Œìœ ìëŠ” ìì‹ ì˜ ì•±ì´ ì–´ë–¤ Gatewayë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ì§€ ì§€ì •í•  ìˆ˜ ìˆê³ , ì¸í”„ë¼ ì†Œìœ ìëŠ” Gatewayê°€ ì–´ë–¤ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ ì–´ë–¤ íƒ€ì…ì˜ Routeë¥¼ í—ˆìš©í• ì§€ ì œí•œí•  ìˆ˜ ìˆì–´.


### Cross-Namespaces at ACME

ì´ë²ˆì—ëŠ” ê°€ìƒì˜ ACME íšŒì‚¬ì™€ ê·¸ ì•ˆì— ìˆëŠ” ì„¸ ê°œì˜ ë‹¤ë¥¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¶€ì„œë¥¼ ì˜ˆì‹œë¡œ ë“¤ì–´ ë³¸ë‹¤.
ê° ë¶€ì„œì—ëŠ” ìì²´ í™˜ê²½, ì• í”Œë¦¬ì¼€ì´ì…˜, ê·¸ë¦¬ê³  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ìˆë‹¤.
- ì±„ìš©íŒ€(Recruiting Team):  ì§€ì›ìë“¤ì´ ì´ë ¥ì„œë¥¼ ì œì¶œí•  ìˆ˜ ìˆëŠ” ëŒ€ì™¸ìš© `careers` ì•±ì„ ìš´ì˜í•˜ê³  ìˆë‹¤.
- ì œí’ˆíŒ€(Product Team): ì ì¬ ê³ ê°ì´ ACME ì œí’ˆì— ëŒ€í•´ ë” ì•Œì•„ë³¼ ìˆ˜ ìˆëŠ” ëŒ€ì™¸ìš© `product` ì•±ì„ ìš´ì˜í•˜ê³  ìˆë‹¤.
- ì¸ì‚¬íŒ€(HR Team): ì§ì›ë“¤ì˜ ê°œì¸ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ë‚´ë¶€ìš© `hr` ì•±ì„ ìš´ì˜í•˜ê³  ìˆë‹¤.

ê° ì•±ì€ ìì²´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë°°í¬ë˜ì–´ ìˆë‹¤. `careers`ì™€ `product` ì•±ì€ ëª¨ë‘ ëŒ€ì™¸ìš©ì´ê¸° ë•Œë¬¸ì— ë³´ì•ˆíŒ€ì´ ê³µìœ  `Gateway API` ì‚¬ìš©ì„ ìŠ¹ì¸í–ˆë‹¤. 
ê³µìœ  `Gateway API`ì˜ ì¥ì ì€ í”Œë«í¼ ë° ë³´ì•ˆíŒ€ì´ ì¸ì¦ì„œ ê´€ë¦¬ë¥¼ í¬í•¨í•œ `Gateway API`ë¥¼ ì¤‘ì•™ì—ì„œ í†µì œí•  ìˆ˜ ìˆë‹¤ëŠ” ì ì´ë‹¤.

í¼ë¸”ë¦­ í´ë¼ìš°ë“œì—ì„œëŠ” ë¹„ìš© ì ˆê° íš¨ê³¼ë„ ìˆë‹¤(ì•±ë‹¹ Gateway APIë¥¼ ì‚¬ìš©í•˜ë©´ ê³µê°œ IPì™€ í´ë¼ìš°ë“œ ë¡œë“œ ë°¸ëŸ°ì„œê°€ í•„ìš”í•˜ê³ , ì´ë“¤ì€ ë¬´ë£Œ ìì›ì´ ì•„ë‹˜).

í•˜ì§€ë§Œ ë³´ì•ˆíŒ€ì€ `hr` ì•±ì˜ ì •ë³´ê°€ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ë¡œ ë…¸ì¶œë˜ê±°ë‚˜ ì ‘ê·¼ë˜ëŠ” ê²ƒì„ ì›í•˜ì§€ ì•ŠëŠ”ë‹¤. ê·¸ë˜ì„œ `hr` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ Gatewayë¡œ HTTPRouteë¥¼ ì—°ê²°í•˜ëŠ” ê²ƒì„ ìŠ¹ì¸í•˜ì§€ ì•Šì•˜ë‹¤.

![img_82.png](../assets/6week/img_82.png)

### Cross-Namespaces Gateway
ì‘ì—…ì´ ì‹œì‘ë  ë•Œ ë„¤ ê°œì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìŒ.

```bash
kubectl get ns --show-labels infra-ns careers product hr
```
![img_83.png](../assets/6week/img_83.png)
`product`ì™€ `careers`ì—ëŠ” `shared-gateway-access=true` ë ˆì´ë¸”ì´ ìˆì§€ë§Œ, `hr`ì—ëŠ” ì´ ë ˆì´ë¸”ì´ ì—†ë‹¤.


Gateway ë° HTTPRoute ë°°í¬
```bash
kubectl apply -f cross-namespace.yaml
yq cross-namespace.yaml
```


Gateway ì •ì˜ì—ì„œ infra-ns ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë°°í¬ëœ ê²ƒ í™•ì¸
![img_84.png](../assets/6week/img_84.png)

GatewayëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì…€ë ‰í„°ë¥¼ ì‚¬ìš©í•´ì„œ ì–´ë–¤ HTTPRouteê°€ ì—°ê²°ë  ìˆ˜ ìˆëŠ”ì§€ ì •ì˜í•˜ê³  ìˆë‹¤.
ì´ë¥¼ í†µí•´ ì¸í”„ë¼ íŒ€ì€ íŠ¹ì • ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì§‘í•©ì„ í—ˆìš© ëª©ë¡ì— ì¶”ê°€í•¨ìœ¼ë¡œì¨ ì–´ë–¤ ì•±ì´ ì´ Gatewayë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ ì œì–´í•  ìˆ˜ ìˆë‹¤.
![img_85.png](../assets/6week/img_85.png)
`shared-gateway-access: "true"` ë ˆì´ë¸”ì´ ìˆëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë§Œ ê³µìœ  Gatewayì— Routeë¥¼ ì—°ê²°í•  ìˆ˜ ìˆë”°.

HTTPRoute ì •ì˜ì—ì„œëŠ” parentRefsì—ì„œ shared-gatewayë¥¼ ì°¸ì¡°í•œë‹¤. ì—°ê²°í•˜ë ¤ëŠ” Gatewayì™€ ê·¸ Gatewayê°€ ì†í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì§€ì •í–ˆë‹¤.


HTTPRouteë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ ë¨¼ì € Gateway IPë¥¼ ê°€ì ¸ì˜¨ë‹¤.
```bash
GATEWAY=$(kubectl get gateway shared-gateway -n infra-ns -o jsonpath='{.status.addresses[0].value}')
echo $GATEWAY
```
![img_86.png](../assets/6week/img_86.png)


ì´ì œ `product`ì™€ `careers` ì„œë¹„ìŠ¤ì— ì—°ê²°í•œë‹¤.
```bash
curl -s -o /dev/null -w "%{http_code}\n" http://$GATEWAY/product
```

![img_87.png](../assets/6week/img_87.png)
200ë°˜í™˜

```bash
curl -s -o /dev/null -w "%{http_code}\n" http://$GATEWAY/careers
```

![img_88.png](../assets/6week/img_88.png)
200ë°˜í™˜


hrì—°ê²°ì‹œë„ 
```bash
curl -s -o /dev/null -w "%{http_code}\n" http://$GATEWAY/hr
```

![img_89.png](../assets/6week/img_89.png)
404ë°˜í™˜

`hr` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ HTTPRouteëŠ” `infra-ns/shared-gateway`ë¥¼ ë¶€ëª¨ë¡œ ì°¸ì¡°í•˜ì§€ë§Œ, ì—°ê²° ì œì•½ ì¡°ê±´(ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë ˆì´ë¸”)ì„ ì¶©ì¡±í•˜ì§€ ëª»í–ˆê¸° ë•Œë¬¸ì— `Gateway`ì— ì˜í•´ ë¬´ì‹œë¨
<br><br><br>

HTTPRouteì˜ ìƒíƒœë¥¼ í™•ì¸í•´ì„œ ê²€ì¦
```bash
echo "Product HTTPRoute Status"
kubectl get httproutes.gateway.networking.k8s.io -n product -o jsonpath='{.items[0].status.parents[0].conditions[0]}' | jq
echo "Careers HTTPRoute Status"
kubectl get httproutes.gateway.networking.k8s.io -n careers -o jsonpath='{.items[0].status.parents[0].conditions[0]}' | jq
echo "HR HTTPRoute Status"
kubectl get httproutes.gateway.networking.k8s.io -n hr -o jsonpath='{.items[0].status.parents[0].conditions[0]}' | jq
```

![img_90.png](../assets/6week/img_90.png)

ì²« ë‘ ëª…ë ¹ì–´ëŠ” `Accepted HTTPRoute`ë¥¼ ë³´ì—¬ì£¼ì§€ë§Œ, ë§ˆì§€ë§‰ ëª…ë ¹ì–´ëŠ” ê±°ë¶€ë˜ì—ˆë‹¤.(ìƒíƒœê°€ `False`ì´ê³ , ë©”ì‹œì§€ëŠ” `HTTPRoute is not allowed to attach to this Gateway`ë¡œ ì‹œì‘í•œë‹¤.)
ì´ ê¸°ëŠ¥ì€ ì—”ì§€ë‹ˆì–´ë“¤ì—ê²Œ ë‹¤ì–‘í•œ ì„ íƒì§€ë¥¼ ì œê³µí•œë‹¤: í•„ìš”í•˜ë‹¤ë©´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë‚˜ ì•±ë‹¹ ì „ìš© `Gateway API`ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, ì¤‘ì•™ ì§‘ì¤‘ì‹ ê´€ë¦¬ì™€ ë¹„ìš© ì ˆê°ì„ ìœ„í•´ ê³µìœ  `Gateway API`ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆë‹¤.

## gRPCì™€ Gateway API
gRPCì™€ Gateway API
ì›¹ í”„ë¡œí† ì½œì˜ ì™•ì¢ŒëŠ” ì—¬ì „íˆ HTTPê°€ ì°¨ì§€í•˜ê³  ìˆì§€ë§Œ, gRPCëŠ” ë‚®ì€ ì§€ì—° ì‹œê°„ê³¼ ë†’ì€ ì²˜ë¦¬ëŸ‰ ë•ë¶„ì— ê·¸ ì‚¬ìš©ì´ ì ì  ëŠ˜ê³  ìˆë‹¤.
Cilium Gateway APIë¥¼ ì‚¬ìš©í•´ì„œ gRPC ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìœ„í•œ ì¿ ë²„ë„¤í‹°ìŠ¤ gRPC ë¼ìš°íŠ¸ë¥¼ ì–´ë–»ê²Œ ë°°í¬í•˜ëŠ”ì§€ ì‚´í´ë³¸ë‹¤.
ì´ë²ˆ ì±Œë¦°ì§€ì—ì„œëŠ” ì—¬ëŸ¬ ì„œë¹„ìŠ¤ë¡œ êµ¬ì„±ëœ ìƒ˜í”Œ gRPC ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•  ê±°ì•¼.

- ğŸ“§ email
- ğŸ›’ checkout ë° cart
- ğŸ’¡ recommendation
- ğŸ‘¨â€ğŸ’» frontend
- ğŸ’³ payment
- ğŸšš shipping
- ğŸ’± currency
- ğŸ“¦ productcatalog

ì´ ì±Œë¦°ì§€ì—ì„œëŠ” ë‹¤ìŒ ë‘ ê°€ì§€ ê²½ë¡œ ì ‘ë‘ì‚¬ë¥¼ ê°€ì§„ `gRPCRoute`ë¥¼ ì„¤ì •í•œë‹¤.
- `/hipstershop.ProductCatalogService`ëŠ” `productcatalog` ì„œë¹„ìŠ¤ë¡œ ì—°ê²°ëœë‹¤.
- `/hipstershop.CurrencyService`ëŠ” currency ì„œë¹„ìŠ¤ë¡œ ì—°ê²°ëœë‹¤.

ì–´í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì¹˜
```bash
kubectl apply -f /opt/gcp-microservices-demo.yml
```

gRPCëŠ” ë°”ì´ë„ˆë¦¬ë¡œ ì¸ì½”ë”©ë˜ê¸° ë•Œë¬¸ì—, gRPC ìš”ì²­ì„ ë³´ë‚´ë ¤ë©´ gRPC ì„œë¹„ìŠ¤ì˜ í”„ë¡œí† (proto) ì •ì˜ê°€ í•„ìš”í•˜ë‹¤. ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë°ëª¨ ì•±ì˜ proto ì •ì˜ë¥¼ ë‹¤ìš´ë¡œë“œí•œë‹¤.
```bash
curl -o demo.proto https://raw.githubusercontent.com/GoogleCloudPlatform/microservices-demo/main/protos/demo.proto
```

```bash
yq grpc-route.yaml
kubectl apply -f grpc-route.yaml
# ë¡œë“œ ë°¸ëŸ°ì„œì˜ IP ì£¼ì†Œë¥¼ ê°€ì ¸ì™€ì„œ GATEWAY ë³€ìˆ˜ì— ì €ì¥
GATEWAY=$(kubectl get gateway cilium-gw -o jsonpath='{.status.addresses[0].value}')
echo $GATEWAY
```

grpc-route.yamlì€ `productcatalogservice`ì™€ `currencyservice` ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…ë  ìš”ì²­ì˜ ê²½ë¡œë¥¼ ì •ì˜í•˜ê³  ìˆì–´.
```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: GRPCRoute
metadata:
  name: productcatalogservice-rule
spec:
  parentRefs:
    - namespace: default
      name: cilium-gw
  rules:
    - matches:
        - method:
            service: hipstershop.ProductCatalogService
            method: ListProducts
      backendRefs:
        - name: productcatalogservice
          port: 3550
---
apiVersion: gateway.networking.k8s.io/v1
kind: GRPCRoute
metadata:
  name: currencyservice-rule
spec:
  parentRefs:
    - namespace: default
      name: cilium-gw
  rules:
    - matches:
        - method:
            service: hipstershop.CurrencyService
            method: GetSupportedCurrencies
      backendRefs:
        - name: currencyservice
          port: 7000
```


ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì°¨ë¡€ë¡œ ì‹¤í–‰í•´ì„œ ëª¨ë“  ë°°í¬ê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸
```bash
kubectl rollout status deploy/emailservice
kubectl rollout status deploy/checkoutservice
kubectl rollout status deploy/recommendationservice
kubectl rollout status deploy/frontend
kubectl rollout status deploy/paymentservice
kubectl rollout status deploy/productcatalogservice
kubectl rollout status deploy/cartservice
kubectl rollout status deploy/loadgenerator
kubectl rollout status deploy/currencyservice
kubectl rollout status deploy/shippingservice
kubectl rollout status deploy/redis-cart
kubectl rollout status deploy/adservice
```

![img_91.png](../assets/6week/img_91.png)


ì´ì œ ì‡¼í•‘ ì•±ì´ ì§€ì›í•˜ëŠ” í†µí™”ë¥¼ ë‚˜ì—´í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ CurrencyServiceì— ì ‘ê·¼í•´ë³´ì.
```bash
grpcurl -plaintext -proto ./demo.proto $GATEWAY:80 hipstershop.CurrencyService/GetSupportedCurrencies | jq
```

![img_92.png](../assets/6week/img_92.png)

ProductCatalogServiceì—ë„ ì ‘ê·¼í•´ë³´ì.
```bash
grpcurl -plaintext -proto ./demo.proto $GATEWAY:80 hipstershop.ProductCatalogService/ListProducts | jq
```
![img_93.png](../assets/6week/img_93.png)

## ì¿ ë²„ë„¤í‹°ìŠ¤ ì„œë¹„ìŠ¤ì˜ í•œê³„

ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ Service ë¦¬ì†ŒìŠ¤ëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ íŠ¸ë˜í”½(East-West)ì˜ ë¡œë“œ ë°¸ëŸ°ì‹±ì„ ê°€ëŠ¥í•˜ê²Œ í•œë‹¤. í•˜ì§€ë§Œ ë¡œë“œ ë°¸ëŸ°ì‹± ì˜µì…˜ì´ ë§¤ìš° ì œí•œì ì´ë‹¤.
L3/L4ë§Œ ê°€ëŠ¥í•˜ê³ , ì„ íƒì ìœ¼ë¡œ í† í´ë¡œì§€ íŒíŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì„ ë¿ì´ë‹¤.
ë ˆì´ì–´ 7 ë¡œë“œ ë°¸ëŸ°ì‹±ê³¼ ê³ ê¸‰ ë¼ìš°íŒ…ì„ êµ¬í˜„í•˜ë ¤ë©´ ë³´í†µ í´ëŸ¬ìŠ¤í„°ì— ì„œë¹„ìŠ¤ ë©”ì‹œ ì†”ë£¨ì…˜ì„ ë°°í¬í•´ì•¼ í•œë‹¤.
ì´ëŠ” ì£¼ë¡œ ì„œë¹„ìŠ¤ ë©”ì‹œ ì†”ë£¨ì…˜ì— íŠ¹í™”ëœ ë¹„í‘œì¤€ ë¦¬ì†ŒìŠ¤ íƒ€ì…ì„ ì‚¬ìš©í•œë‹¤ëŠ” ì˜ë¯¸ì´ë©°
ê·¸ë ‡ë‹¤ë©´ ì¶”ê°€ ì»´í¬ë„ŒíŠ¸ ì—†ì´, í‘œì¤€ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•´ì„œ ì´ëŸ¬í•œ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ì—†ì„ê¹Œì˜ ê³ ë¯¼ì´ í•„ìš”í–ˆë‹¤.

## GAMMA ì´ë‹ˆì…”í‹°ë¸Œ
GAMMA(Gateway API for Mesh Management and Administration) ì´ë‹ˆì…”í‹°ë¸ŒëŠ” Gateway API í•˜ìœ„ í”„ë¡œì íŠ¸ì˜ ì „ìš© ì‘ì—… ìŠ¤íŠ¸ë¦¼ì´ë‹¤.
ì´ë‹ˆì…”í‹°ë¸Œì˜ ëª©í‘œëŠ” ì„œë¹„ìŠ¤ ë©”ì‹œë¥¼ êµ¬ì„±í•˜ê¸° ìœ„í•´ Gateway APIë¥¼ ì–´ë–»ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ ì •ì˜í•˜ëŠ” ê²ƒì´ë©° ì´ë•Œ, Gateway APIì— ìµœì†Œí•œì˜ ë³€ê²½ì„ ê°€í•˜ë©´ì„œ Gateway APIì˜ ì—­í•  ì¤‘ì‹¬ì (role-oriented) ì„±ê²©ì„ í•­ìƒ ìœ ì§€í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ ì‚¼ê³  ìˆë‹¤.

## GAMMA ì´ë‹ˆì…”í‹°ë¸Œì˜ ì—­í• 
Gateway API v1.0ì—ì„œ GAMMAëŠ” HTTPRouteë¥¼ ë¶€ëª¨ë¡œì„œ Serviceì— ë°”ì¸ë”©í•¨ìœ¼ë¡œì¨ ì„œë¹„ìŠ¤ì— ì¶”ê°€ì ì¸ HTTP ë¼ìš°íŒ…ì„ ì§€ì›í•œë‹¤. 
ì´ëŠ” ì§€ê¸ˆê¹Œì§€ ë©ì—ì„œ ë³¸ ê²ƒì²˜ëŸ¼ HTTPRouteë¥¼ Gatewayì— ë°”ì¸ë”©í•˜ëŠ” ë¶/ë‚¨(north/south) ë°©í–¥ì˜ Gateway API ì‚¬ìš©ê³¼ëŠ” ëŒ€ì¡°ì ì´ë‹¤.
GAMMAëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œ ë ˆì´ì–´ 7 íŠ¸ë˜í”½ ê´€ë¦¬ ê¸°ëŠ¥ì„ ìœ„í•œ í‘œì¤€ APIë¥¼ ì œê³µí•œë‹¤.

ì´ë²ˆ ì±Œë¦°ì§€ì—ì„œ ìì„¸íˆ ì•Œì•„ë³¸ë‹¤. 


### ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬

ìƒ˜í”Œì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ í™•ì¸
```bash
kubectl apply -f gamma-manifest.yaml
kubectl -n gamma get pods,svc
```
![img_94.png](../assets/6week/img_94.png)

### EAST/WEST HTTPRoute ë°°í¬
```bash
yq gamma-route.yaml
```

```yaml
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: gamma-route
  namespace: gamma
spec:
  parentRefs:
    - group: ""
      kind: Service
      name: echo
  rules:
    - matches:
        - path:
            type: Exact
            value: /v1
      backendRefs:
        - name: echo-v1
          port: 80
    - matches:
        - path:
            type: Exact
            value: /v2
      backendRefs:
        - name: echo-v2
          port: 80
```

ë¼ìš°íŠ¸ë¥¼ (ë¶/ë‚¨ ë°©í–¥ì˜) Gatewayì— ì—°ê²°í•˜ëŠ” ëŒ€ì‹ , parentRefs í•„ë“œë¥¼ ì‚¬ìš©í•´ì„œ **echo**ë¼ëŠ” ë¶€ëª¨ Serviceì— ë¼ìš°íŠ¸ë¥¼ ì—°ê²°

ì´ ë¶€ëª¨ ì„œë¹„ìŠ¤ë¡œ í–¥í•˜ëŠ” íŠ¸ë˜í”½ì€ Ciliumì— ì˜í•´ ê°€ë¡œì±„ì ¸ì„œ ë…¸ë“œë³„ Envoy í”„ë¡ì‹œë¥¼ í†µí•´ ë¼ìš°íŒ…ëœë‹¤.

ì—¬ê¸°ì„œëŠ” `/v1` ê²½ë¡œë¡œ í–¥í•˜ëŠ” íŠ¸ë˜í”½ì„ `echo-v1` ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬í•˜ê³ , `/v2`ë„ ë§ˆì°¬ê°€ì§€ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
ì˜ˆë¥¼ ë“¤ì–´, ì´ëŸ° ë°©ì‹ìœ¼ë¡œ ë‚´ë¶€ ì•±ì— ëŒ€í•œ A/B í…ŒìŠ¤íŠ¸ë‚˜ ê·¸ë¦°/ë¸”ë£¨ ì¹´ë‚˜ë¦¬ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.

![img_95.png](../assets/6week/img_95.png)


ë¨¼ì € í´ë¼ì´ì–¸íŠ¸ íŒŒë“œê°€ ì¤€ë¹„ë˜ì–´ìˆëŠ”ì§€ í™•ì¸

```bash
kubectl get -n gamma pods client
```
ì´ì œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ http://echo/v1ì— ì ‘ê·¼í•´ ë³¸ë‹¤. echo-v1 Podê°€ ìì‹ ì˜ í˜¸ìŠ¤íŠ¸ëª…ì„ í¬í•¨í•œ ì •ë³´ë¡œ ì‘ë‹µí•œë‹¤..
```bash
kubectl -n gamma exec -it client -- curl http://echo/v1
```

![img_96.png](../assets/6week/img_96.png)

ì´ë²ˆì—ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ http://echo/v2ì— ì ‘ê·¼í•´ ë³¸ë‹¤.
ì´ë²ˆì—ëŠ” íŠ¸ë˜í”½ì´ echo-v2 ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” echo Podë¡œ ì „ë‹¬ëœë‹¤.
grepì„ ì‚¬ìš©í•´ì„œ echo-v2 Podê°€ íŠ¸ë˜í”½ì„ ë°›ì•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.
```
kubectl -n gamma exec -it client -- curl http://echo/v2
```

![img_97.png](../assets/6week/img_97.png)

Gateway APIì™€ ë™ì¼í•œ APIì™€ ë¡œì§ì„ ì‚¬ìš©í•´ì„œ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ ë™/ì„œ íŠ¸ë˜í”½ì— ëŒ€í•´ ê²½ë¡œ ê¸°ë°˜ ë¼ìš°íŒ…ì„ í•  ìˆ˜ ìˆë‹¤.


### East-West ë¡œë“œë°¸ëŸ°ìŠ¤

```bash
kubectl apply -f load-balancing-http-route.yaml
yq load-balancing-http-route.yaml
```

ë§¤ë‹ˆí˜ìŠ¤íŠ¸ëŠ” ê°„ë‹¨í•œ L7 í”„ë¡ì‹œ ë¼ìš°íŠ¸ ê·œì¹™ì„ ì¶”ê°€í•œë‹¤. /load-balancingìœ¼ë¡œ ì‹œì‘í•˜ëŠ” HTTP íŠ¸ë˜í”½ì„ echo-v1 ë° echo-v2 ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: gamma-route
  namespace: gamma
spec:
  parentRefs:
    - group: ""
      kind: Service
      name: echo
  rules:
    - matches:
        - path:
            type: Exact
            value: /v1
      backendRefs:
        - name: echo-v1
          port: 80
    - matches:
        - path:
            type: Exact
            value: /v2
      backendRefs:
        - name: echo-v2
          port: 80
    - matches:
        - path:
            type: PathPrefix
            value: /load-balancing
      backendRefs:
        - kind: Service
          name: echo-v1
          port: 80
          weight: 50
        - kind: Service
          name: echo-v2
          port: 80
          weight: 50
```
50/50ìœ¼ë¡œ ê· ë“±í•˜ê²Œ ê°€ì¤‘ì¹˜ê°€ ì„¤ì •ëœ ê²ƒì„ ì£¼ëª©
![img_98.png](../assets/6week/img_98.png)
![img_99.png](../assets/6week/img_99.png)

ë£¨í”„ë¥¼ ì‹¤í–‰í•˜ê³  ìš”ì²­ íšŸìˆ˜ë¥¼ ì„¸ì–´ íŠ¸ë˜í”½ì´ ë‘ ì„œë¹„ìŠ¤ì— ê· ë“±í•˜ê²Œ ë¶„í• ë˜ëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•œë‹¤. 
```bash
kubectl -n gamma exec -it client -- bash -c '
for _ in {1..500}; do
  curl -s -k "http://echo/load-balancing" >> curlresponses.txt;
done
grep -o "Hostname=echo-v1" curlresponses.txt | sort | uniq -c
grep -o "Hostname=echo-v2" curlresponses.txt | sort | uniq -c
'
```
ëŒ€ëµì ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ì´ ì‘ë‹µì´ 50:50ìœ¼ë¡œ ë¶„ì‚°ë˜ì—ˆë‹¤.
![img_100.png](../assets/6week/img_100.png)

### 90/10 íŠ¸ë˜í”½ ë¶„í• 

![img_101.png](../assets/6week/img_101.png)


`load-balancing-http-route.yaml` íŒŒì¼ì„ í¸ì§‘í•œë‹¤. `echo-v1`ê³¼ `echo-v2`ì˜ ê°€ì¤‘ì¹˜ 50ì„ ê°ê° `echo-v1`ì€ 90, `echo-v2`ëŠ” 10ìœ¼ë¡œ ëŒ€ì²´í•œë‹¤.

```bash
kubectl -n gamma exec -it client -- bash -c '
for _ in {1..500}; do
  curl -s -k "http://echo/load-balancing" >> curlresponses9010.txt;
done
grep -o "Hostname=echo-v1" curlresponses9010.txt | sort | uniq -c
grep -o "Hostname=echo-v2" curlresponses9010.txt | sort | uniq -c
'
```
![img_102.png](../assets/6week/img_102.png)


### Timeouts

ë¨¼ì € ì„œë¹„ìŠ¤ì˜ ì‘ë‹µ í—¤ë”ë¥¼ í™•ì¸í•œë‹¤. 
```bash
kubectl -n gamma exec -it client -- curl http://echo/v1
```

ì´ ì‹œì ì—ëŠ” íƒ€ì„ì•„ì›ƒì„ ì–¸ê¸‰í•˜ëŠ” í—¤ë”ê°€ ì—†ë‹¤. 
`load-balancing-http-route.yaml`íŒŒì¼ì— ì´ì œ ë¼ìš°íŠ¸ì— 10ms íƒ€ì„ì•„ì›ƒì„ ì¶”ê°€í•´ë³´ì. 


```bash
- matches:
    - path:
        type: Exact
        value: /v1
    backendRefs:
    - name: echo-v1
      port: 80
    timeouts:
      request: 10ms
```

![img_103.png](../assets/6week/img_103.png)

ì¬ì ìš©
```bash
kubectl apply -f load-balancing-http-route.yaml
```

í…ŒìŠ¤íŠ¸ìš”ì²­
```bash
kubectl -n gamma exec -it client -- curl http://echo/v1
```

![img_104.png](../assets/6week/img_104.png)
ì‘ë‹µì—ì„œ íƒ€ì„ì•„ì›ƒ ì„¤ì •ì„ ë‚˜íƒ€ë‚´ëŠ” ìƒˆë¡œìš´ Envoy í—¤ë”ì¸ `X-Envoy-Expected-Rq-Timeout-Ms:10`ì„ ë³¼ ìˆ˜ ìˆë‹¤.

ê°™ì€ ë°©ì‹ìœ¼ë¡œ 1msë¡œ ë³€ê²½í•´ë³´ì. ì•„ë˜ì™€ ê°™ì´ ë§¤ìš° ë‚®ì€ ì„ê³„ê°’ ë•Œë¬¸ì—, ëŒ€ë¶€ë¶„ì˜ ê²½ìš° íƒ€ì„ì•„ì›ƒ ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤.
![img_105.png](../assets/6week/img_105.png)
